<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Panel del Administrador</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <h2>Bienvenido al panel de administración, <span th:text="${usuario.nombre}"></span></h2>

    <div th:if="${isAdminPrincipal}">
        <div class="dropdown">
            <button type="button" onclick="toggleDropdown()" class="btn-registrar">Registrar Admin</button>
            <div id="dropdownContent" class="dropdown-content">
                <form th:action="@{/admin/registrar-admin}" th:object="${nuevoAdmin}" method="post" id="formRegistroAdmin">
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" th:field="*{nombre}" placeholder="Ej: Juan Pérez" required><br>
                    <label for="email">Correo Electrónico:</label>
                    <input type="email" id="email" th:field="*{email}" placeholder="Ej: admin@ejemplo.com" required><br>
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" th:field="*{password}" placeholder="••••••••" required><br>
                    <button type="submit" class="btn-submit">Registrar Admin</button>
                    <button type="button" onclick="toggleDropdown()" class="btn-cancel">Cancelar</button>
                </form>
            </div>
        </div>
    </div>

    <h3>Lista de Reportes</h3>
    <table border="1">
        <tr>
            <th>Título</th>
            <th>Descripción</th>
            <th>Dirección</th>
            <th>Barrio</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Fecha Creación</th>
            <th>Usuario</th>
            <th>Admin Asignado</th>
            <th>Acciones</th>
        </tr>
        <tr th:each="r : ${reportes}">
            <td th:text="${r.titulo}"></td>
            <td th:text="${r.descripcion}"></td>
            <td th:text="${r.direccion}"></td>
            <td th:text="${r.barrio.nombre}"></td>
            <td th:text="${r.tipo.nombre}"></td>
            <td th:text="${r.estado}"></td>
            <td th:text="${#temporals.format(r.fechaCreacion, 'dd/MM/yyyy HH:mm')}"></td>
            <td th:text="${r.usuario.nombre}"></td>
            <td th:text="${r.usuarioAdmin != null ? r.usuarioAdmin.nombre : 'No asignado'}"></td>
            <td>
                <a href="#" th:attr="data-id=${r.id}" onclick="confirmarEliminar(this)">Eliminar</a> |
                <select th:disabled="${r.estado == 'RESUELTO'}" onchange="mostrarConfirmacionCambioEstado(this)" th:attr="data-id=${r.id}">
                    <option value="" selected disabled>Cambiar Estado</option>
                    <option th:value="'EN_PROGRESO'" th:selected="${r.estado == 'EN_PROGRESO'}">En Progreso</option>
                    <option th:value="'RESUELTO'" th:selected="${r.estado == 'RESUELTO'}">Resuelto</option>
                </select>
            </td>
        </tr>
    </table>

    <br>
    <button type="button" id="btnSalir">Salir</button>

    <script>
        // Función para mostrar/ocultar el menú desplegable
        function toggleDropdown() {
            const dropdownContent = document.getElementById("dropdownContent");
            if (dropdownContent.style.display === "block") {
                dropdownContent.style.display = "none";
            } else {
                dropdownContent.style.display = "block";
            }
        }

        // Cerrar el dropdown si se hace clic fuera
        document.addEventListener("click", function(event) {
            const dropdown = document.querySelector(".dropdown");
            const dropdownContent = document.getElementById("dropdownContent");
            if (!dropdown.contains(event.target)) {
                dropdownContent.style.display = "none";
            }
        });

        function confirmarEliminar(element) {
            event.preventDefault();
            const id = element.getAttribute("data-id");
            Swal.fire({
                title: "¿Eliminar este reporte?",
                text: "Esta acción no se puede deshacer.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Sí, eliminar",
                cancelButtonText: "No, cancelar"
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/admin/eliminar-reporte/${id}`;
                }
            });
        }

        function mostrarConfirmacionCambioEstado(select) {
            const id = select.getAttribute("data-id");
            const nuevoEstado = select.value;
            if (nuevoEstado) {
                // Obtener el estado actual del reporte desde el DOM
                const estadoActual = select.closest('tr').querySelector('td:nth-child(6)').textContent.trim();
                if (estadoActual === 'RESUELTO' && nuevoEstado !== 'RESUELTO') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'El estado no puede ser cambiado porque el reporte ya fue resuelto.',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        select.value = ''; // Reset select
                    });
                } else {
                    Swal.fire({
                        title: "¿Cambiar el estado del reporte?",
                        text: `Cambiar a ${nuevoEstado.replace('_', ' ')}`,
                        icon: "question",
                        showCancelButton: true,
                        confirmButtonText: "Sí, cambiar",
                        cancelButtonText: "No, cancelar"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const form = document.createElement('form');
                            form.method = 'post';
                            form.action = '/admin/cambiar-estado';
                            form.innerHTML = `<input type="hidden" name="reporteId" value="${id}">
                                              <input type="hidden" name="nuevoEstado" value="${nuevoEstado}">`;
                            document.body.appendChild(form);
                            form.submit();
                        } else {
                            select.value = ''; // Reset select
                        }
                    });
                }
            }
        }

        // Mostrar modal de éxito solo después de cambiar el estado
        document.addEventListener("DOMContentLoaded", () => {
            const successMessage = "${successMessage}" !== "null" ? "${successMessage}" : null;
            if (successMessage && window.location.search.includes("successMessage")) {
                Swal.fire({
                    icon: 'success',
                    title: 'Éxito',
                    text: successMessage,
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.history.replaceState({}, document.title, window.location.pathname);
                });
            }

            const form = document.getElementById("formRegistroAdmin");
            if (form) {
                form.addEventListener("submit", (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    console.log("Enviando datos:", Object.fromEntries(formData));
                    fetch('/admin/registrar-admin', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Respuesta no válida: ' + response.status);
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: data.success,
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'Error al registrar',
                                confirmButtonText: 'OK'
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Error en fetch:", error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error en la solicitud: ' + error.message,
                            confirmButtonText: 'OK'
                        });
                    });
                });
            }
        });

        document.getElementById("btnSalir").addEventListener("click", () => {
            Swal.fire({
                title: "¿Cerrar sesión?",
                text: "Se cerrará tu sesión actual.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Sí, salir",
                cancelButtonText: "No, quedarme"
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "/logout";
                }
            });
        });
    </script>
</body>
</html>
